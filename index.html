<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Web Terminal | Alpine Linux</title>
    <!-- Core UI Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    
    <!-- Emulator Engine Local - Primary -->
    <script src="./libv86.js" onerror="console.warn('Local libv86.js failed to load, waiting for fallback.')"></script>

    <style>
        :root {
            --bg-color: #1a1b26;
            --header-bg: #16161e;
            --accent-color: #7aa2f7;
            --text-muted: #565f89;
            --success-color: #9ce200;
        }

        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            background-color: var(--bg-color); 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        #header {
            background-color: var(--header-bg);
            height: 32px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #24283b;
            justify-content: space-between;
            z-index: 20;
        }

        .header-section {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-color);
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-muted);
        }

        .status-dot.active {
            background-color: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }

        #terminal-container { 
            flex: 1;
            width: 100%;
            background-color: var(--bg-color);
        }

        #overlay {
            position: absolute; 
            top: 32px; 
            left: 0; 
            width: 100%; 
            height: calc(100% - 32px);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            color: var(--accent-color); 
            text-align: center; 
            z-index: 10; 
            background: var(--bg-color);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loader-box {
            background: var(--header-bg);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #24283b;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .spinner {
            border: 3px solid rgba(122, 162, 247, 0.1); 
            width: 32px; 
            height: 32px;
            border-radius: 50%; 
            border-left-color: var(--accent-color); 
            animation: spin 0.8s linear infinite; 
            margin: 0 auto 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { opacity: 0; pointer-events: none; }
        
        #debug-console {
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            font-family: monospace;
            font-size: 10px;
            color: #414868;
            pointer-events: none;
            text-align: right;
            max-height: 100px;
            overflow: hidden;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header id="header">
            <div class="header-section">
                <div class="status-pill">
                    <div id="connection-dot" class="status-dot"></div>
                    <span id="system-label">SYSTEM OFFLINE</span>
                </div>
                <span style="opacity: 0.3">|</span>
                <span>Alpine Linux x86</span>
            </div>
            <div class="header-section">
                <span id="mem-usage">MEM: 256MB</span>
                <span id="cpu-load">CPU: IDLE</span>
            </div>
        </header>

        <div id="terminal-container"></div>
    </div>

    <div id="overlay">
        <div class="loader-box">
            <div class="spinner"></div>
            <p id="boot-status" style="margin: 0; font-weight: 500; letter-spacing: 0.5px;">INITIALIZING CORE...</p>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px;">Loading artifacts from repository...</p>
        </div>
    </div>

    <div id="debug-console"></div>

    <script>
        const WASM_PATH = "./v86.wasm";
        const ALPINE_IMAGE = "./linux.iso";
        const BIOS_IMAGE = "./seabios.bin";
        const V86_FALLBACK_CDN = "https://cdn.jsdelivr.net/npm/v86@0.10.2/build/libv86.js";

        let term, fitAddon, emulator;

        function log(msg) {
            console.log(`%c[VM] ${msg}`, "color: #7aa2f7");
            const debug = document.getElementById('debug-console');
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            debug.appendChild(line);
            if (debug.childNodes.length > 8) debug.removeChild(debug.firstChild);
        }

        function loadExternalScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = () => {
                    log("External script loaded: " + src);
                    resolve();
                };
                script.onerror = () => reject(new Error("Failed to load script: " + src));
                document.head.appendChild(script);
            });
        }

        async function init() {
            // 1. Terminal Setup
            term = new Terminal({
                cursorBlink: true,
                fontFamily: '"JetBrains Mono", "Cascadia Code", Menlo, monospace',
                fontSize: 14,
                lineHeight: 1.2,
                theme: {
                    background: '#1a1b26',
                    foreground: '#a9b1d6',
                    cursor: '#c0caf5',
                    selectionBackground: '#33467c',
                    black: '#15161e',
                    red: '#f7768e',
                    green: '#9ce200',
                    yellow: '#e0af68',
                    blue: '#7aa2f7',
                    magenta: '#bb9af7',
                    cyan: '#7dcfff',
                    white: '#a9b1d6'
                }
            });

            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            term.open(document.getElementById('terminal-container'));
            fitAddon.fit();

            log("UI Engine Ready.");

            try {
                // Modified logic to handle global scope more effectively
                const findV86 = () => {
                    if (typeof window.V86Starter !== 'undefined') return window.V86Starter;
                    if (typeof V86Starter !== 'undefined') return V86Starter;
                    return null;
                };

                log("Verifying Emulator Library...");
                let v86Class = findV86();

                if (!v86Class) {
                    log("Local engine missing from scope. Fetching CDN...");
                    try {
                        await loadExternalScript(V86_FALLBACK_CDN);
                        // Poll for a brief moment to let global register
                        for (let i = 0; i < 20; i++) {
                            v86Class = findV86();
                            if (v86Class) break;
                            await new Promise(r => setTimeout(r, 100));
                        }
                    } catch (err) {
                        log("CDN fallback failed.");
                    }
                }

                if (!v86Class) {
                    throw new Error("Emulator library (V86Starter) failed to initialize.");
                }

                log("Engine confirmed. Preparing Boot...");
                document.getElementById('boot-status').innerText = "PREPARING VIRTUAL MACHINE...";
                bootVM(v86Class);

            } catch (e) {
                log("Fatal: " + e.message);
                term.writeln("\r\n\x1b[31m[FATAL ERROR]\x1b[0m " + e.message);
                term.writeln("\x1b[33m[DEBUG]\x1b[0m Verify ./libv86.js contains the V86Starter class.");
                document.getElementById('boot-status').innerText = "BOOT FAILED";
                document.getElementById('boot-status').style.color = "#f7768e";
            }
        }

        function bootVM(V86Class) {
            log("Initializing V86 instance...");
            
            try {
                emulator = new V86Class({
                    wasm_path: WASM_PATH,
                    memory_size: 256 * 1024 * 1024,
                    vga_as_text_mode: true,
                    bios: { url: BIOS_IMAGE },
                    cdrom: { url: ALPINE_IMAGE },
                    autostart: true,
                });

                const dot = document.getElementById('connection-dot');
                const label = document.getElementById('system-label');

                emulator.add_listener("serial0-output-char", (char) => {
                    const overlay = document.getElementById('overlay');
                    if (overlay && !overlay.classList.contains('hidden')) {
                        overlay.classList.add('hidden');
                        dot.classList.add('active');
                        label.innerText = "SYSTEM ACTIVE";
                        log("Serial link established.");
                    }
                    term.write(char);
                });

                emulator.add_listener("download-error", (url) => {
                    log("Download failed: " + url);
                    term.writeln(`\r\n\x1b[31m[IO_ERROR]\x1b[0m File not found or blocked: ${url}`);
                });

                term.onData(data => {
                    if (emulator) emulator.serial0_send(data);
                });

                window.addEventListener('resize', () => fitAddon.fit());
                term.focus();
                
            } catch (err) {
                log("Constructor error: " + err.message);
                term.writeln("\r\n\x1b[31m[CONSTRUCTOR_ERROR]\x1b[0m " + err.message);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
