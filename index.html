<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Web Terminal | Alpine Linux</title>
    <!-- Core UI Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    
    <style>
        :root {
            --bg-color: #1a1b26;
            --header-bg: #16161e;
            --accent-color: #7aa2f7;
            --text-muted: #565f89;
            --success-color: #9ce200;
            --error-color: #f7768e;
        }

        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            background-color: var(--bg-color); 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        #header {
            background-color: var(--header-bg);
            height: 32px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #24283b;
            justify-content: space-between;
            z-index: 20;
        }

        .header-section {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-color);
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-muted);
        }

        .status-dot.active {
            background-color: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }

        #terminal-container { 
            flex: 1;
            width: 100%;
            background-color: var(--bg-color);
        }

        #overlay {
            position: absolute; 
            top: 32px; 
            left: 0; 
            width: 100%; 
            height: calc(100% - 32px);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            color: var(--accent-color); 
            text-align: center; 
            z-index: 10; 
            background: var(--bg-color);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loader-box {
            background: var(--header-bg);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #24283b;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 320px;
        }

        .spinner {
            border: 3px solid rgba(122, 162, 247, 0.1); 
            width: 32px; 
            height: 32px;
            border-radius: 50%; 
            border-left-color: var(--accent-color); 
            animation: spin 0.8s linear infinite; 
            margin: 0 auto 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { opacity: 0; pointer-events: none; }
        
        #debug-console {
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            font-family: monospace;
            font-size: 10px;
            color: #414868;
            pointer-events: none;
            text-align: right;
            max-height: 100px;
            overflow: hidden;
        }

        .version-tag {
            background: #24283b;
            color: var(--accent-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .diagnostic-step {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin: 4px 0;
            color: var(--text-muted);
        }

        .diagnostic-step span:last-child {
            font-weight: bold;
        }

        .step-success { color: var(--success-color); }
        .step-fail { color: var(--error-color); }
    </style>
</head>
<body>

    <div id="app-container">
        <header id="header">
            <div class="header-section">
                <div class="status-pill">
                    <div id="connection-dot" class="status-dot"></div>
                    <span id="system-label">SYSTEM OFFLINE</span>
                </div>
                <span style="opacity: 0.3">|</span>
                <span>Alpine Linux x86</span>
                <span class="version-tag">v1.9</span>
            </div>
            <div class="header-section">
                <span id="mem-usage">MEM: 256MB</span>
                <span id="cpu-load">CPU: IDLE</span>
            </div>
        </header>

        <div id="terminal-container"></div>
    </div>

    <div id="overlay">
        <div class="loader-box">
            <div class="spinner"></div>
            <p id="boot-status" style="margin: 0; font-weight: 500; letter-spacing: 0.5px;">PRE-FLIGHT CHECK...</p>
            <div id="diagnostic-list" style="margin-top: 15px; text-align: left; padding: 0 10px;">
                <!-- Steps will be injected here -->
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 20px;">Build version: 1.9.0</p>
        </div>
    </div>

    <div id="debug-console"></div>

    <script>
        const REQUIRED_FILES = {
            LIBRARY: "./libv86.js",
            WASM: "./v86.wasm",
            ISO: "./linux.iso",
            BIOS: "./seabios.bin"
        };

        let term, fitAddon, emulator;

        function log(msg) {
            console.log(`%c[VM] ${msg}`, "color: #7aa2f7");
            const debug = document.getElementById('debug-console');
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            debug.appendChild(line);
            if (debug.childNodes.length > 8) debug.removeChild(debug.firstChild);
        }

        function updateDiagnostic(id, status, isError = false) {
            const list = document.getElementById('diagnostic-list');
            let item = document.getElementById(`diag-${id}`);
            if (!item) {
                item = document.createElement('div');
                item.id = `diag-${id}`;
                item.className = 'diagnostic-step';
                item.innerHTML = `<span>${id}:</span> <span class="step-status">...</span>`;
                list.appendChild(item);
            }
            const statusSpan = item.querySelector('.step-status');
            statusSpan.innerText = status;
            statusSpan.className = isError ? 'step-status step-fail' : 'step-status step-success';
        }

        async function checkFile(name, url) {
            updateDiagnostic(name, "CHECKING");
            try {
                const response = await fetch(url, { method: 'GET' });
                if (response.ok) {
                    const text = await response.text();
                    if (text.length < 100) {
                         updateDiagnostic(name, "EMPTY/SHORT", true);
                         return false;
                    }
                    updateDiagnostic(name, "OK");
                    return true;
                } else {
                    updateDiagnostic(name, `FAIL (${response.status})`, true);
                    return false;
                }
            } catch (e) {
                updateDiagnostic(name, "ERR", true);
                return false;
            }
        }

        /**
         * Robust script loader using Module-to-Global Shim
         * Version 1.7 wraps the library in a scope that captures exports
         * and explicitly maps them to window.V86Starter.
         */
        async function loadScriptRobustly(url) {
            updateDiagnostic("JS_LOAD", "FETCHING");
            try {
                const response = await fetch(url);
                const scriptText = await response.text();
                
                log("Script fetched. Injecting Global Shim...");
                
                try {
                    // Create a shim that simulates a module environment to capture isolated exports
                    const shim = `
                        (function() {
                            var module = { exports: {} };
                            var exports = module.exports;
                            (function() {
                                ${scriptText}
                            }).call(window);
                            
                            // Force manual export if the library didn't set window.V86Starter
                            window.V86Starter = window.V86Starter || 
                                              module.exports.V86Starter || 
                                              module.exports || 
                                              this.V86Starter;
                            
                            console.log("[Shim] Export check:", !!window.V86Starter);
                        }).call(window);
                    `;

                    const script = document.createElement('script');
                    script.text = shim;
                    document.head.appendChild(script);
                    
                    updateDiagnostic("JS_LOAD", "SHIMMED");
                    return true;
                } catch (execError) {
                    log("Shim execution error: " + execError.message);
                    updateDiagnostic("JS_LOAD", "EXEC_FAIL", true);
                    return false;
                }
            } catch (e) {
                updateDiagnostic("JS_LOAD", "FETCH_FAIL", true);
                return false;
            }
        }

        async function init() {
            // 1. Terminal Setup
            term = new Terminal({
                cursorBlink: true,
                fontFamily: '"JetBrains Mono", "Cascadia Code", Menlo, monospace',
                fontSize: 14,
                lineHeight: 1.2,
                theme: {
                    background: '#1a1b26',
                    foreground: '#a9b1d6',
                    cursor: '#c0caf5',
                    selectionBackground: '#33467c',
                    black: '#15161e',
                    red: '#f7768e',
                    green: '#9ce200',
                    yellow: '#e0af68',
                    blue: '#7aa2f7',
                    magenta: '#bb9af7',
                    cyan: '#7dcfff',
                    white: '#a9b1d6'
                }
            });

            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            term.open(document.getElementById('terminal-container'));
            fitAddon.fit();

            log("UI Engine Ready (Build 1.9).");

            try {
                // 2. Pre-flight Check
                const results = await Promise.all([
                    checkFile("LIB_FILE", REQUIRED_FILES.LIBRARY),
                    checkFile("WASM_FILE", REQUIRED_FILES.WASM),
                    checkFile("ISO_FILE", REQUIRED_FILES.ISO),
                    checkFile("BIOS_FILE", REQUIRED_FILES.BIOS)
                ]);

                if (results.includes(false)) {
                    throw new Error("One or more local files are missing or invalid.");
                }

                // 3. Load Engine
                await loadScriptRobustly(REQUIRED_FILES.LIBRARY);

                log("Verifying Engine Scope...");
                
                const findV86 = () => {
                    return window.V86Starter || 
                           (typeof V86Starter !== 'undefined' ? V86Starter : null) ||
                           window.v86 ||
                           (typeof v86 !== 'undefined' ? v86 : null);
                };
                
                let v86Class = findV86();
                if (!v86Class) {
                    log("V86 not found yet, polling...");
                    for (let i = 0; i < 50; i++) {
                        v86Class = findV86();
                        if (v86Class) break;
                        await new Promise(r => setTimeout(r, 100));
                        if (i % 10 === 0 && i > 0) log(`Global check retry: ${i/10}s...`);
                    }
                }

                if (!v86Class) {
                    updateDiagnostic("ENGINE", "MISSING", true);
                    throw new Error("V86Starter class not found in global scope after Shim injection.");
                }
                
                // --- INTROSPECTION START ---
                // Handle case where export is an object wrapping the constructor
                log("V86 Object found. Type: " + typeof v86Class);
                
                if (typeof v86Class !== 'function') {
                     log("V86 is not a function. Inspecting properties...");
                     if (v86Class.V86Starter && typeof v86Class.V86Starter === 'function') {
                         log("Found V86Starter inside object.");
                         v86Class = v86Class.V86Starter;
                     } else if (v86Class.default && typeof v86Class.default === 'function') {
                         log("Found default export inside object.");
                         v86Class = v86Class.default;
                     } else if (v86Class.V86 && typeof v86Class.V86 === 'function') {
                         log("Found V86 inside object.");
                         v86Class = v86Class.V86;
                     } else {
                         const keys = Object.keys(v86Class);
                         log("Available keys: " + keys.join(", "));
                     }
                }
                // --- INTROSPECTION END ---

                updateDiagnostic("ENGINE", "READY");
                log("Engine confirmed. Preparing Boot...");
                document.getElementById('boot-status').innerText = "BOOTING...";
                bootVM(v86Class);

            } catch (e) {
                log("Fatal: " + e.message);
                term.writeln("\r\n\x1b[31m[FATAL ERROR]\x1b[0m " + e.message);
                term.writeln("\x1b[33m[DEBUG]\x1b[0m Ensure Build version 1.9.0 is displayed on screen.");
                document.getElementById('boot-status').innerText = "STOPPED";
                document.getElementById('boot-status').style.color = "#f7768e";
            }
        }

        function bootVM(V86Class) {
            try {
                // Final safety check before instantiation
                if (typeof V86Class !== 'function') {
                    throw new Error("Resolved V86 object is still not a constructor. Check logs.");
                }

                emulator = new V86Class({
                    wasm_path: REQUIRED_FILES.WASM,
                    memory_size: 256 * 1024 * 1024,
                    vga_as_text_mode: true,
                    bios: { url: REQUIRED_FILES.BIOS },
                    cdrom: { url: REQUIRED_FILES.ISO },
                    autostart: true,
                });

                const dot = document.getElementById('connection-dot');
                const label = document.getElementById('system-label');

                emulator.add_listener("serial0-output-char", (char) => {
                    const overlay = document.getElementById('overlay');
                    if (overlay && !overlay.classList.contains('hidden')) {
                        overlay.classList.add('hidden');
                        dot.classList.add('active');
                        label.innerText = "SYSTEM ACTIVE";
                        log("Serial stream established.");
                    }
                    term.write(char);
                });

                emulator.add_listener("download-error", (url) => {
                    log("VM Download error: " + url);
                    term.writeln(`\r\n\x1b[31m[VM_FETCH_FAIL]\x1b[0m ${url}`);
                });

                term.onData(data => {
                    if (emulator) emulator.serial0_send(data);
                });

                window.addEventListener('resize', () => fitAddon.fit());
                term.focus();
                
            } catch (err) {
                log("Boot logic failure: " + err.message);
                term.writeln("\r\n\x1b[31m[RUNTIME_ERROR]\x1b[0m " + err.message);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
